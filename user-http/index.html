<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>useR - http</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- solarized theme -->
		<!-- <link rel="stylesheet" href="css/theme/solarized.css" id="theme"> -->

		<!-- google fonts -->
		<link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>

		<!-- fontawesome -->
		<!-- <link rel="stylesheet" href="css/fontawesome-free-5.0.13/web-fonts-with-css/css/fontawesome-all.css"> -->
		<script defer src="https://use.fontawesome.com/releases/v5.7.2/js/all.js" integrity="sha384-0pzryjIRos8mFBWMzSSZApWtPl/5++eIfzYmTgBBmXYdhvxPc+XcFEk+zJwDgWbP" crossorigin="anonymous"></script>

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<style type="text/css">
			#rotate_text {
				-webkit-transform: rotate(-90deg);
				-moz-transform: rotate(-90deg);
				transform: rotate(-90deg);
				position: absolute;
				vertical-align: middle;
				position: absolute;
    		top: 500px;
    		left: -50px;
				filter:progid:DXImageTransform.Microsoft.BasicImage(rotation=3);
			}

			.reveal section ul.a {list-style-type: circle; margin: 0; padding: 0;}
			.reveal section ul.b {list-style-type: square; margin-left: 4; padding-left: 0;}

			/*.reveal section img {border: none;}*/

			.center-block {
			  display: block;
			  margin-left: auto;
			  margin-right: auto;
			}

			.reveal table th, td {
			  padding: 0px;
			}
		</style>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">

		<!-- Abstract: Many R users request data from the web in their scripts and packages. This talk introduces a modern suite of packages for managing HTTP requests. The crul package is a modern HTTP request library, including asynchronous requests, automatic handling of pagination, and more. Importantly, crul provides an R6 based object system that makes it easier to program with relative to other tools. The webmockr package mocks HTTP requests, returning user specified mocked responses matching the format of the real thing. The vcr package leverages webmockr to cache HTTP requests and responses. Both webmockr and vcr support many HTTP libraries. Last, httpcode provides information on all HTTP codes, and fauxpas provides proper HTTP error classes for use in most HTTP R libraries. These tools together provide a modern way for R programmers to manage HTTP requests. -->				
		
		<section id="intro" class="center">
			<h1><font color="#B8172F">HTTP Requests for Users &amp; Package Developers</font></h1><br>
			<p class="grey">Scott Chamberlain (<i class="fab fa-twitter"></i> <a href="https://twitter.com/sckottie">@sckottie</a>)
				<!-- <p class="grey">rOpenSci -->
			<br>
			<span><img src="img/icon_lettering_white.svg" alt="rOpenSci" width="600" /></span>
		</section>

		<section id="outline">
			<h1>outline</h1>
			<ul>
				<li>crul</li>
				<li>webmockr</li>
				<li>vcr</li>
				<li>fauxpas</li>
				<li>httpcode</li>
			</ul>
			<br><br>
			<h1>users vs. developers</h1>
			<ul>
				<li>users: webmockr in scripts</li>
				<li>developers: crul/webmockr/vcr, show egs</li>
			</ul>
		</section>

		<section id="crul">
			<h1>crul - a new http client</h1>
			<br>
			<h3>arose to scratch my own http itch</h3>
			<br>
			<h3>lots of pkgs that do http requests</h3>
			<br>
			<h3><i class="fab fa-github"></i> <a href="https://github.com/ropensci/crul/">ropensci/crul</a></h3>
		</section>

		<section id="crul-name">
			<h3>the pkg name is a mess, sorry!</h3>
			<br>
			<h3>could have a cool sticker some day though</h3>
			<h3>hadley's idea: a glaive from <a href="https://krull.fandom.com/wiki/Glaive">Krull</a></h3>
			<br>
			<img src="img/krull_glaive.webp" width="500">
		</section>

		<section id="crul-features">
			<h1>crul - features</h1>
			<br>
			<ul class="b">
				<!-- <li><h3 align="left">confusingly close to <i>curl</i></h3></li> -->
				<li><h3 align="left">asynchronous requests</h3></li>
				<li><h3 align="left">pagination</h3></li>
				<li><h3 align="left">supports mocking</h3></li>
				<li><h3 align="left">writing to disk + streaming</h3></li>
				<li><h3 align="left">request + response hooks</h3></li>
				<br>
				<li><h3 align="left">does not have: OAuth</h3></li>
				<ul class="b">
					<li><h3 align="left">not something I need ...</h3></li>
				</ul>
			</ul>
		</section>

		<section id="crul-pkgs">
			<h1>crul - lots of example usage</h1>
			<br>
			<img src="img/crul_usage.png">
		</section>

		<section data-markdown id="crul-demo-1">
			<script>
				# crul demo

				```r
				con <- crul::HttpClient$new(url = "https://httpbin.org")
				con$get(path = "get")
				```

				```r
				<crul response>
				  url: https://httpbin.org/get
				  request_headers:
				    User-Agent: libcurl/7.54.0 r-curl/3.3 crul/0.7.4
				    Accept-Encoding: gzip, deflate
				    Accept: application/json, text/xml, application/xml, */*
				  response_headers:
				    status: HTTP/1.1 200 OK
				    access-control-allow-credentials: true
				    access-control-allow-origin: *
				    content-encoding: gzip
				    content-type: application/json
				    date: Wed, 12 Jun 2019 23:21:09 GMT
				    referrer-policy: no-referrer-when-downgrade
				    server: nginx
				    x-content-type-options: nosniff
				    x-frame-options: DENY
				    x-xss-protection: 1; mode=block
				    content-length: 218
				    connection: keep-alive
				  status: 200
				```

				Returns an R6 object
			</script>
		</section>

		<section data-markdown id="crul-demo-2">
			<script>
				# crul demo

				Index to results and methods with `$`

				```r
				res$request
				res$content
				res$times
				res$modified
				res$response_headers_all
				res$response_headers
				res$request_headers
				res$status_code
				res$handle
				res$opts
				res$url
				res$method
				res$clone()
				res$raise_for_status()
				res$status_http()
				res$success()
				res$parse()
				res$initialize()
				res$print()
				```
			</script>
		</section>

		<section data-markdown id="crul-demo-xxx">
			<script>
				# what else to demo?
			</script>
		</section>

		<section id="webmockr">
			<h1>webmockr - mock http requests</h1>
			<br>
			<h3>arose to scratch my own http itch</h3>
			<br>
			<h3><i class="fab fa-github"></i> <a href="https://github.com/ropensci/webmockr/">ropensci/webmockr</a></h3>
		</section>

		<section id="webmockr-what-does-it-do">
			<h1>webmockr - what does it do?</h1>
			<br>
			<h3>set what you want to <font color="blue">match against</font> &amp; what to <font color="orange">return</font></h3>
			<br>
			<h3>make a request</h3>
			<br>
			<h3>if it matches you get what you set to <font color="orange">return</font></h3>
			<br>
			<h3>if it doesn't match: <font color="grey">error</font></h3>
		</section>

		<section data-markdown id="webmockr-eg">
			<script>
				## webmockr - example

				```r
				library(crul)
				library(webmockr)
				```

				```r
				stub_request("get", "https://httpbin.org/get") %>%
				  wi_th(query = list(hello = "world")) %>% to_return(status = 418)
				#> <webmockr stub> 
				#>   method: get
				#>   uri: https://httpbin.org/get
				#>   with: 
				#>     query: hello=world
				#>     body: 
				#>     request_headers: 
				#>   to_return: 
				#>     status: 418
				#>     body: 
				#>     response_headers: 
				#>   should_timeout: FALSE
				#>   should_raise: FALSE
				```

				```r
				HttpClient$new()$get(path = 'get', query = list(hello = "world"))
				#> <crul response> 
				#>   url: https://httpbin.org/get?hello=world
				#>   request_headers: 
				#>     User-Agent: libcurl/7.54.0 r-curl/3.3 crul/0.7.0.9310
				#>     Accept-Encoding: gzip, deflate
				#>     Accept: application/json, text/xml, application/xml, */*
				#>   response_headers: 
				#>   params: 
				#>     hello: world
				#>   status: 418
				```
			</script>
		</section>

		<section data-markdown id="webmockr-no-match">
			<script>
				## webmockr - no matching stub

				```r
				GET("https://httpbin.org/get")
				#> Error: Real HTTP connections are disabled.
				#> Unregistered request:
				#>   GET https://httpbin.org/get   with headers 
				#>       {Accept: application/json, text/xml, application/xml, */*}
				#> 
				#> You can stub this request with the following snippet:
				#> 
				#>    stub_request('get', uri = 'https://httpbin.org/get') %>%
				#>      wi_th(
				#>        headers = list(
				#>          'Accept' = 'application/json, text/xml, application/xml, */*'
				#>        )
				#>      )
				```
			</script>
		</section>

		<section data-markdown id="webmockr-no-match">
			<script>
				## what next ...
			</script>
		</section>

		<section id="vcr">
			<h1>vcr - record and replay HTTP requests/responses</h1>
			<br>
			<h3>arose to scratch my own http itch</h3>
			<br>
			<h3><i class="fab fa-github"></i> <a href="https://github.com/ropensci/vcr/">ropensci/vcr</a></h3>
		</section>

		<section id="vcr-was-hard">
			<h2>vcr - hardest software project I've worked on</h2>
			<br>
			<img src="img/vcr_ruby.png" height="300">
			<br>
			<i class="fas fa-arrow-down fa-3x"></i>
			<br>
			<img src="img/vcr_r.png" height="220">
		</section>

		<section data-markdown id="vcr-was-hard-hard">
			<script>
				## vcr - hardest software project I've worked on

				### Ruby
				
				```ruby
				def has_interaction_matching?(request)
   !!matching_interaction_index_for(request) ||
      !!matching_used_interaction_for(request) ||
      @parent_list.has_interaction_matching?(request)
end
				```

				<br>WTF?<br><br>

				### R

				```r
				has_interaction_matching = function(request) {
   private$matching_interaction_bool(request) ||
     private$matching_used_interaction_for(request) ||
     self$parent_list$has_interaction_matching()
}
				```
				
			</script>
		</section>

		<section data-markdown id="vcr-monkey-patching">
			<script>
				## vcr - no monkey patching in R!

				### Allowed in Ruby, but not in R

				<br>

				### in R we can do

				```r
				assignInNamespace(
				  x = "some_object", 
				  vale = function(e) e,
				  ns = "some_other_pkg"
				)
				```
				<br>
				But this will not be allowed on CRAN
			</script>
		</section>

		<section id="vcr-totally-didnt-get-it">
			<h1>vcr - how does it even?</h1>
			<br>
			<h3>thought vcr worked by "over-hearing" <i class="fas fa-headphones-alt"></i> requests in R</h3>
			<br>
			<h3>realized it most definitely did not</h3>
			<br>
			<h3>it modifies an HTTP request &amp; looks for a match</h3>
			<br>
			<h3>so had to make <code>webmockr</code> first</h3>
		</section>

		<section id="vcr-what-does-it-do">
			<h1>vcr - what does it do?</h1>
			<br>
			<h3>HTTP requests in a test suite as usual</h3>
			<br>
			<h3>w/o making real HTTP requests</h3>
			<br>
			<h3>so you test your package</h3>
			<br>
			<h3>not the remote service</h3>
			<h4>(p.s. great for rate-limited services)</h4>
		</section>

		<section data-markdown id="vcr-speed">
			<script>
				# speeds up your tests

				## w/o vcr

				```r
				➜ Rscript -e 'devtools::test()'
Testing worrms
✔ |  OK F W S | Context
✔ |  15       | wm_children [10.0 s]
✔ |   6       | wm_classification [1.4 s]
✔ |  ..       | ...
══ Results ═════════
Duration: 141.0 s
				```

				## w/ vcr

				```r
				➜ Rscript -e 'devtools::test()'
Testing worrms
✔ |  OK F W S | Context
✔ |  15       | wm_children [3.8 s]
✔ |   6       | wm_classification [0.5 s]
✔ |  ..       | ...
══ Results ═════════
Duration: 35.6 s
				```
			</script>
		</section>

		<section id="vcr-all-clients">
			<h1>vcr - client agnostic</h1>
			<br>
			<ul class="b">
				<li><h3 align="left">works w/ crul</h3></li>
				<li><h3 align="left">works w/ httr</h3></li>
				<li><h3 align="left">may or may not work w/ curl</h3></li>
			</ul>
		</section>

		<section id="further-reading">
			<h1>further reading</h1>
			<br>
			<i class="fas fa-book-open fa-3x"></i>
			<br><br>
			<h2>HTTP Testing Book:<br><a href="https://ropenscilabs.github.io/http-testing-book/">ropenscilabs.github.io/http-testing-book</a></h2>
			<br>
			<h3>crul/webmockr/vcr in detail - w/ caveats/edge cases/etc.</h3>
		</section>

		<section id="bib" class="center">
			<h2>slides: <a href="https://scotttalks.info/user-http">scotttalks.info/user-http</a></h2>
			<h2>Made w/: <a href="https://github.com/hakimel/reveal.js">reveal.js v3.7.0</a>, <a href="http://fortawesome.github.io/Font-Awesome/">FontAwesome v5.7.2</a></h2>
		</section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				history: true,
				center: false,
				width: 1400,
				height: 900,
				transition: "none",
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
